<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPC Merchandise Register</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Trash2, History, Download, ShoppingCart, Plus, Minus } = lucideReact;

        const SPCMerchandiseRegister = () => {
          const [cart, setCart] = useState([]);
          const [amountPaid, setAmountPaid] = useState('');
          const [transactions, setTransactions] = useState([]);
          const [showHistory, setShowHistory] = useState(false);
          const [notification, setNotification] = useState(null);

          const products = [
            { id: 1, name: 'T-shirt', price: 15 },
            { id: 2, name: 'Felpa', price: 25 },
            { id: 3, name: 'Zainetta', price: 15 },
            { id: 4, name: 'Stickers SPC', price: 5 },
            { id: 5, name: 'Locandina festival', price: 5 },
            { id: 6, name: 'Manifesti Lesbiche Più', price: 20 },
            { id: 7, name: 'Manifesto ShaShat', price: 5 }
          ];

          // Carica dati dal localStorage al mount
          useEffect(() => {
            const savedTransactions = localStorage.getItem('spc-merchandise-transactions');
            if (savedTransactions) {
              setTransactions(JSON.parse(savedTransactions));
            }
          }, []);

          // Salva transazioni nel localStorage
          useEffect(() => {
            localStorage.setItem('spc-merchandise-transactions', JSON.stringify(transactions));
          }, [transactions]);

          const showNotification = (message, type = 'success') => {
            setNotification({ message, type });
            setTimeout(() => setNotification(null), 3000);
          };

          const addToCart = (product) => {
            setCart(prevCart => {
              const existingItem = prevCart.find(item => item.id === product.id);
              if (existingItem) {
                return prevCart.map(item =>
                  item.id === product.id
                    ? { ...item, quantity: item.quantity + 1 }
                    : item
                );
              }
              return [...prevCart, { ...product, quantity: 1 }];
            });
          };

          const removeFromCart = (productId) => {
            setCart(prevCart => {
              const existingItem = prevCart.find(item => item.id === productId);
              if (existingItem && existingItem.quantity > 1) {
                return prevCart.map(item =>
                  item.id === productId
                    ? { ...item, quantity: item.quantity - 1 }
                    : item
                );
              }
              return prevCart.filter(item => item.id !== productId);
            });
          };

          const removeItemCompletely = (productId) => {
            setCart(prevCart => prevCart.filter(item => item.id !== productId));
          };

          const getTotal = () => {
            return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
          };

          const getChange = () => {
            if (!amountPaid || amountPaid.trim() === '') {
              return null;
            }
            const paid = parseFloat(amountPaid);
            const total = getTotal();
            if (isNaN(paid)) {
              return null;
            }
            return paid - total;
          };

          const completeSale = () => {
            if (cart.length === 0) {
              showNotification('Aggiungi almeno un prodotto al carrello!', 'error');
              return;
            }

            const total = getTotal();
            let transaction;
            
            if (!amountPaid || amountPaid.trim() === '') {
              transaction = {
                id: Date.now(),
                date: new Date().toLocaleDateString('it-IT'),
                time: new Date().toLocaleTimeString('it-IT'),
                items: [...cart],
                total: total,
                paid: null,
                change: null
              };
              
              setTransactions(prev => [transaction, ...prev]);
              setCart([]);
              setAmountPaid('');
              
              showNotification(`Vendita completata! Totale: €${total.toFixed(2)}`, 'success');
              
            } else {
              const paid = parseFloat(amountPaid);
              if (isNaN(paid)) {
                showNotification('Inserisci un importo valido!', 'error');
                return;
              }
              if (paid < total) {
                showNotification('Importo pagato insufficiente!', 'error');
                return;
              }
              
              const change = paid - total;
              
              transaction = {
                id: Date.now(),
                date: new Date().toLocaleDateString('it-IT'),
                time: new Date().toLocaleTimeString('it-IT'),
                items: [...cart],
                total: total,
                paid: paid,
                change: change
              };
              
              setTransactions(prev => [transaction, ...prev]);
              setCart([]);
              setAmountPaid('');
              
              showNotification(`Vendita completata! Totale: €${total.toFixed(2)} | Pagato: €${paid.toFixed(2)} | Resto: €${change.toFixed(2)}`, 'success');
            }
          };

          const newSale = () => {
            setCart([]);
            setAmountPaid('');
          };

          const getTodayTransactions = () => {
            const today = new Date().toLocaleDateString('it-IT');
            return transactions.filter(t => t.date === today);
          };

          const getTodayTotal = () => {
            return getTodayTransactions().reduce((sum, t) => sum + t.total, 0);
          };

          const exportToPDF = () => {
            const allTransactions = transactions;
            
            const productSummary = {};
            allTransactions.forEach(transaction => {
              transaction.items.forEach(item => {
                if (productSummary[item.name]) {
                  productSummary[item.name].quantity += item.quantity;
                  productSummary[item.name].total += item.price * item.quantity;
                } else {
                  productSummary[item.name] = {
                    quantity: item.quantity,
                    pricePerUnit: item.price,
                    total: item.price * item.quantity
                  };
                }
              });
            });

            const allTransactionsTotal = allTransactions.reduce((sum, t) => sum + t.total, 0);

            let csvContent = "RIEPILOGO TOTALE VENDITE,,,,\n";
            csvContent += "Prodotto,Quantità Venduta,Prezzo Unitario,Totale\n";
            
            Object.entries(productSummary).forEach(([productName, data]) => {
              csvContent += `"${productName}",${data.quantity},€${data.pricePerUnit.toFixed(2)},€${data.total.toFixed(2)}\n`;
            });
            
            csvContent += `\n"TOTALE GENERALE",,, €${allTransactionsTotal.toFixed(2)}\n`;
            
            const now = new Date();
            const todayTransactions = getTodayTransactions();
            csvContent += `\n"Data Report","${now.toLocaleDateString('it-IT')}",,\n`;
            csvContent += `"Ora Report","${now.toLocaleTimeString('it-IT')}",,\n`;
            csvContent += `"Numero Transazioni Totali","${allTransactions.length}",,\n`;
            csvContent += `"Numero Transazioni Oggi","${todayTransactions.length}",,\n`;
            csvContent += `"Vendite Oggi","€${getTodayTotal().toFixed(2)}",,\n`;
            
            csvContent += `\n"DETTAGLIO TUTTE LE TRANSAZIONI",,,,\n`;
            csvContent += `"Data","Ora","Prodotto","Quantità","Prezzo Unit.","Totale Prodotto","Totale Transazione"\n`;
            
            const sortedTransactions = [...allTransactions].sort((a, b) => {
              const dateCompare = new Date(b.date.split('/').reverse().join('-')).getTime() - 
                              new Date(a.date.split('/').reverse().join('-')).getTime();
              if (dateCompare !== 0) return dateCompare;
              return b.time.localeCompare(a.time);
            });
            
            sortedTransactions.forEach(transaction => {
              transaction.items.forEach((item, itemIndex) => {
                csvContent += `"${transaction.date}","${transaction.time}","${item.name}",${item.quantity},€${item.price.toFixed(2)},€${(item.price * item.quantity).toFixed(2)}`;
                if (itemIndex === 0) {
                  csvContent += `,€${transaction.total.toFixed(2)}`;
                } else {
                  csvContent += `,`;
                }
                csvContent += `\n`;
              });
            });

            const downloadTime = now.toLocaleDateString('it-IT').replace(/\//g, '-') + '_' + 
                            now.toLocaleTimeString('it-IT').replace(/:/g, '-');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `SPC-Merchandise-Report-Completo-${downloadTime}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
          };

          const NotificationComponent = () => {
            if (!notification) return null;
            
            return (
              <div className={`fixed top-2 left-2 right-2 z-50 p-2 rounded-lg shadow-lg text-center text-sm ${
                notification.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
              }`}>
                {notification.message}
              </div>
            );
          };

          if (showHistory) {
            return (
              <div className="min-h-screen bg-gray-50 p-2">
                <NotificationComponent />
                <div className="max-w-4xl mx-auto">
                  <div className="bg-white rounded-lg shadow-lg p-3">
                    <div className="flex justify-between items-center mb-4">
                      <h1 className="text-xl font-bold text-gray-800">Storico Transazioni</h1>
                      <button
                        onClick={() => setShowHistory(false)}
                        className="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm"
                      >
                        Torna al Registro
                      </button>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                      <div className="bg-green-100 p-3 rounded-lg text-center">
                        <h3 className="font-semibold text-green-800 text-sm">Vendite Oggi</h3>
                        <p className="text-xl font-bold text-green-600">€{getTodayTotal().toFixed(2)}</p>
                      </div>
                      <div className="bg-blue-100 p-3 rounded-lg text-center">
                        <h3 className="font-semibold text-blue-800 text-sm">Transazioni Oggi</h3>
                        <p className="text-xl font-bold text-blue-600">{getTodayTransactions().length}</p>
                      </div>
                      <div className="bg-purple-100 p-3 rounded-lg text-center">
                        <button
                          onClick={exportToPDF}
                          className="bg-purple-600 text-white px-3 py-2 rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2 mx-auto text-sm"
                        >
                          <Download size={16} />
                          Esporta Report
                        </button>
                      </div>
                    </div>

                    <div className="space-y-3 max-h-80 overflow-y-auto">
                      {transactions.map(transaction => (
                        <div key={transaction.id} className="border border-gray-200 rounded-lg p-3">
                          <div className="flex justify-between items-center mb-2">
                            <span className="font-semibold text-sm">{transaction.date} - {transaction.time}</span>
                            <span className="bg-green-100 text-green-800 px-2 py-1 rounded-full font-semibold text-sm">
                              €{transaction.total.toFixed(2)}
                            </span>
                          </div>
                          <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs text-gray-600">
                            {transaction.items.map((item, index) => (
                              <div key={index} className="flex justify-between">
                                <span>{item.name} x{item.quantity}</span>
                                <span>€{(item.price * item.quantity).toFixed(2)}</span>
                              </div>
                            ))}
                          </div>
                          <div className="mt-2 pt-2 border-t border-gray-200 flex justify-between text-xs">
                            {transaction.paid !== null ? (
                              <>
                                <span>Pagato: €{transaction.paid.toFixed(2)}</span>
                                <span>Resto: €{transaction.change.toFixed(2)}</span>
                              </>
                            ) : (
                              <span className="text-gray-500 italic">Importo pagato non registrato</span>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gray-50 p-2">
              <div className="max-w-4xl mx-auto">
                <NotificationComponent />
                
                {/* Header compatto */}
                <div className="bg-white rounded-lg shadow-lg p-3 mb-2">
                  <div className="flex justify-between items-center">
                    <h1 className="text-xl font-bold text-gray-800">SPC Merchandise</h1>
                    <div className="text-right">
                      <p className="text-lg font-semibold text-green-600">
                        Totale: €{getTotal().toFixed(2)}
                      </p>
                      <p className="text-xs text-gray-500">
                        Oggi: €{getTodayTotal().toFixed(2)} ({getTodayTransactions().length} vendite)
                      </p>
                    </div>
                  </div>
                </div>

                {/* Prodotti */}
                <div className="bg-white rounded-lg shadow-lg p-3 mb-2">
                  <h2 className="text-lg font-semibold mb-3 flex items-center gap-2">
                    <ShoppingCart size={20} />
                    Prodotti
                  </h2>
                  <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                    {products.map(product => (
                      <button
                        key={product.id}
                        onClick={() => addToCart(product)}
                        style={{ backgroundColor: '#98F7C6', color: '#290BF2' }}
                        className="p-3 rounded-lg font-semibold text-center hover:opacity-80 transition-opacity touch-manipulation min-h-[70px] flex flex-col justify-center"
                      >
                        <span className="text-sm font-bold leading-tight">{product.name}</span>
                        <span className="text-lg font-bold">€{product.price.toFixed(2)}</span>
                      </button>
                    ))}
                  </div>
                </div>

                {/* Carrello */}
                {cart.length > 0 && (
                  <div className="bg-white rounded-lg shadow-lg p-3 mb-2">
                    <h2 className="text-lg font-semibold mb-2">Carrello</h2>
                    <div className="space-y-2">
                      {cart.map(item => (
                        <div key={item.id} className="flex justify-between items-center bg-gray-50 p-2 rounded-lg">
                          <div className="flex-1">
                            <span className="font-semibold text-sm">{item.name}</span>
                            <span className="text-gray-600 ml-2 text-xs">€{item.price.toFixed(2)} x {item.quantity}</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className="font-semibold text-sm">€{(item.price * item.quantity).toFixed(2)}</span>
                            <div className="flex gap-1">
                              <button
                                onClick={() => removeFromCart(item.id)}
                                className="bg-red-100 text-red-600 p-1 rounded hover:bg-red-200 transition-colors"
                              >
                                <Minus size={12} />
                              </button>
                              <button
                                onClick={() => addToCart(item)}
                                className="bg-green-100 text-green-600 p-1 rounded hover:bg-green-200 transition-colors"
                              >
                                <Plus size={12} />
                              </button>
                              <button
                                onClick={() => removeItemCompletely(item.id)}
                                className="bg-red-500 text-white p-1 rounded hover:bg-red-600 transition-colors"
                              >
                                <Trash2 size={12} />
                              </button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Pagamento */}
                <div className="bg-white rounded-lg shadow-lg p-3 mb-2">
                  <h2 className="text-lg font-semibold mb-2">Pagamento</h2>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-xs font-medium mb-1">Importo Pagato (€)</label>
                      <input
                        type="number"
                        step="0.01"
                        value={amountPaid}
                        onChange={(e) => setAmountPaid(e.target.value)}
                        className="w-full p-2 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="0.00"
                      />
                    </div>
                    <div>
                      <label className="block text-xs font-medium mb-1">Resto</label>
                      <div className={`p-2 rounded-lg text-base font-semibold ${
                        getChange() === null ? 'bg-gray-100 text-gray-500' : 
                        getChange() >= 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                      }`}>
                        {getChange() === null ? 'N/A' : `€${getChange().toFixed(2)}`}
                      </div>
                    </div>
                  </div>
                </div>

                {/* Controlli */}
                <div className="bg-white rounded-lg shadow-lg p-3">
                  <div className="grid grid-cols-3 gap-2">
                    <button
                      onClick={completeSale}
                      className="bg-green-600 text-white py-2 px-3 rounded-lg font-semibold hover:bg-green-700 transition-colors text-sm"
                    >
                      Completa Vendita
                    </button>
                    <button
                      onClick={newSale}
                      className="bg-blue-600 text-white py-2 px-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors text-sm"
                    >
                      Nuova Vendita
                    </button>
                    <button
                      onClick={() => setShowHistory(true)}
                      className="bg-purple-600 text-white py-2 px-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors flex items-center justify-center gap-1 text-sm"
                    >
                      <History size={16} />
                      Storico
                    </button>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        ReactDOM.render(<SPCMerchandiseRegister />, document.getElementById('root'));
    </script>
</body>
</html>
